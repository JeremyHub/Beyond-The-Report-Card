{"title":"Beyond the Report Card: What are the significant predictors?","markdown":{"yaml":{"title":"Beyond the Report Card: What are the significant predictors?","author":"Thu Dang, Nathaniel Reimer, Jeremy Hubinger","execute":{"echo":false,"warning":false,"message":false}},"headingText":"LASSO code","containsRefs":false,"markdown":"\n\n```{r packages}\nlibrary(tidyverse)\nlibrary(MetBrewer)\nlibrary(sf)\nlibrary(rnaturalearth)\nlibrary(classInt) #install.packages('classInt')\nlibrary(ggspatial) #install.packages('ggspatial')\nlibrary(ggthemes) #install.packages('ggthemes')\nlibrary(RColorBrewer)\nlibrary(patchwork)\nlibrary(leaflet)\nlibrary(probably) #install.packages('probably')\nlibrary(glmnet)\nlibrary(tidymodels)\nlibrary(ggrepel)\ntidymodels_prefer()\n```\n\n```{r color}\npalname = \"Homer2\"\ndefaultcolor = met.brewer(palname,10)[9]\n```\n\n```{r load datasets}\nload(\"../CombinedDataLongFormat.RData\")\nload(\"../WideMergedData.RData\")\n```\n\n```{r load cleaned dataset for county achievement metrics}\nmath_ca_gcs_df <- read_csv(\"../AllDatasets/math_ca_gcs_df.csv\")\nrla_ca_gcs_df <- read_csv(\"../AllDatasets/rla_ca_gcs_df.csv\")\n```\n\n```{r maps load shapefile}\nca_counties <- read_sf('../CA_Counties')\nca_counties <- ca_counties %>%\n  st_transform(crs = \"NAD83\")\n```\n\n\n```{r lasso data setup}\n\nmin_max_norm <- function(x) {\n    (x - min(x, na.rm=TRUE)) / (max(x, na.rm=TRUE) - min(x, na.rm=TRUE))\n}\n\ndata <- wide_merged_data %>% \n  mutate(pp_total_raw = as.numeric(pp_total_raw)) %>%\n  mutate(science_data_Earth.and.Space.Sciences.Domain.Percent.Above.Standard_99 = as.numeric(science_data_Earth.and.Space.Sciences.Domain.Percent.Above.Standard_99),\n        science_data_Physical.Sciences.Domain.Percent.Above.Standard_99 = as.numeric(science_data_Physical.Sciences.Domain.Percent.Above.Standard_99),\n        science_data_Life.Sciences.Domain.Percent.Above.Standard_99 = as.numeric(science_data_Life.Sciences.Domain.Percent.Above.Standard_99),\n        ela_data_currstatus_ALL = as.numeric(ela_data_currstatus_ALL),\n        gcs = as.numeric(gcs_mn_avg_ol - gradecenter),\n        growthscore_ela = as.numeric(growthscore_ela),\n        growthscore_math = as.numeric(growthscore_math)\n    ) %>% mutate(\n        science_data_Earth.and.Space.Sciences.Domain.Percent.Above.Standard_99 = min_max_norm(science_data_Earth.and.Space.Sciences.Domain.Percent.Above.Standard_99),\n        science_data_Physical.Sciences.Domain.Percent.Above.Standard_99 = min_max_norm(science_data_Physical.Sciences.Domain.Percent.Above.Standard_99),\n        science_data_Life.Sciences.Domain.Percent.Above.Standard_99 = min_max_norm(science_data_Life.Sciences.Domain.Percent.Above.Standard_99),\n        ela_data_currstatus_ALL = min_max_norm(ela_data_currstatus_ALL),\n        gcs = min_max_norm(gcs_mn_avg_ol - gradecenter),\n        growthscore_ela = min_max_norm(growthscore_ela),\n        growthscore_math = min_max_norm(growthscore_math)\n    ) \n\n# Lasso Model Spec\nlm_lasso_spec <- \n  linear_reg() %>%\n  set_args(mixture = 1, penalty = 0) %>%\n  set_engine(engine = 'glmnet') %>% \n  set_mode('regression') \n```\n\n```{r lasso data split}\noutcome <- data %>% select(ela_data_currstatus_ALL, gcs, science_data_Earth.and.Space.Sciences.Domain.Percent.Above.Standard_99, science_data_Life.Sciences.Domain.Percent.Above.Standard_99, science_data_Physical.Sciences.Domain.Percent.Above.Standard_99, growthscore_ela, growthscore_math)\n\npredictors <- ((data %>% select(-starts_with(\"science_data\"), -starts_with(\"ela_data\")))[27:151]) %>% select(-census_id,-DATE_CUR,-CATEGORY,-ST_LEAID,-LEANM,-ST_SCHID,-SCHNAM,-GRADE,STNAM,-FIPST,-LEAID,-reported_which,-reportingyear,-studentgroup,-schoolname.y,       -districtname,-countyname,-EILCode,-EILName,-SOC,-DOC,-YearRoundYN,-FederalDFCDistrictID,-Latitude,-Longitude,-AdmFName,-AdmLName,-AdmEmail,-LastUpDate,-school_id,-         schoolname.x,-ncesdistid_admin,-ncesdistid_geo,-distid_stateassigned,-schoolid_stateassigned,-distname,-address,-city,-state,-zip_code,-level.x,-sedasch,-sedaschname         ,-fips,-stateabb,-subcat,-subgroup,-sedalea,-schnam,-schcity,-type,-level.y,-ncesid,-rtype,-SCHOOL_YEAR,-STNAM,-X, -GSoffered) %>%\n  select(-contains(\"growthscore\"), -contains(\"decilerank\"), -starts_with(\"ELA\"), -starts_with(\"MTH\"), -charter_flag, -coe_flag, -dass_flag, -enrollmetric_raw, -gcs_mn_avg_ol, -gcs_mn_avg_eb) %>%\n  mutate(across(starts_with(\"pp\"), as.numeric)) %>%\n  mutate(across(ends_with(\"raw\"), as.numeric)) %>% \n  mutate(ncesenroll = as.numeric(ncesenroll))\n```\n\n```{r lasso function}\n#| fig-width: 50\n#| fig-height: 10\ndo_lasso<-function(variable, data) {\n    \n    processeddata <- cbind(variable, data) %>%\n      filter(complete.cases(.))\n\n  \n    data_rec <- recipe(variable ~ ., data = processeddata) %>%\n      step_nzv(all_predictors()) %>%\n      step_novel(all_nominal_predictors()) %>%\n      step_normalize(all_numeric_predictors()) %>%\n      step_dummy(all_nominal_predictors())\n    \n    lasso_wf <- workflow() %>%\n      add_recipe(data_rec) %>%\n      add_model(lm_lasso_spec)\n    \n    lasso_fit <- lasso_wf %>%\n      fit(data = processeddata) # Fit to data\n    \n    glmnet_output <- lasso_fit %>% extract_fit_parsnip() %>% pluck('fit')\n    \n    \n    lambdas <- glmnet_output$lambda\n    coefs_lambdas <- \n      coefficients(glmnet_output, s = lambdas )  %>% \n      as.matrix() %>%  \n      t() %>% \n      as.data.frame() %>% \n      mutate(lambda = lambdas ) %>% \n      select(lambda, everything(), -`(Intercept)`) %>% \n      pivot_longer(cols = -lambda, \n                   names_to = \"term\", \n                   values_to = \"coef\") %>%\n      mutate(var = purrr::map_chr(term,~.[1]))\n    \n      number <- nrow(processeddata)\n      name <- deparse(substitute(variable))\n      \n      middle <- coefs_lambdas$lambda[[floor(length(coefs_lambdas$lambda)*0.2)]]\n      \n      coefs_lambdas %>% \n        ggplot(aes(x = lambda, y = coef, group = term, color = var)) +\n          labs(subtitle = paste0(name,\": \",number)) +\n          geom_line() +\n          theme_classic() + \n          theme(legend.position = \"none\", legend.text=element_text(size=8)) +\n          geom_label_repel(data = coefs_lambdas %>% filter(lambda == middle, (coef > 0.001) | (coef < -0.001)), aes(x = lambda, y = coef, label = var))\n        #coord_cartesian(xlim=c(0,max(coefs_lambdas$lambda)*0.5), ylim=c(min(coefs_lambdas$coef)*0.8,max(coefs_lambdas$coef)*0.8))\n}\n```\n\n```{r perform lasso}\ndo_lasso(outcome$ela_data_currstatus_ALL, predictors)\ndo_lasso(outcome$gcs, predictors)\ndo_lasso(outcome$growthscore_ela, predictors)\ndo_lasso(outcome$growthscore_math, predictors)\n```"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":false,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"toc":true,"output-file":"model.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.269","editor":"visual","theme":"zephyr","title":"Beyond the Report Card: What are the significant predictors?","author":"Thu Dang, Nathaniel Reimer, Jeremy Hubinger"},"extensions":{"book":{"multiFile":true}}}}}