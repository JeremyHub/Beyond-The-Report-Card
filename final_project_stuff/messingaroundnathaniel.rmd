---
title: "Untitled"
output: html_document
date: "2023-04-03"
---
```{r}
library(tidyverse)
library(readxl)
library(MetBrewer)
library(sf)
library(rnaturalearth) 
```

## Data Sources

### school_data

[Codebook](https://github.com/JeremyHub/STAT-456-Final/blob/8ef6fa6ce28785065f583f4c477c5deb11afd442/final_project_stuff/school_info_docs.pdf)

```{r school_data}
school_data <- read.csv('ca_education.csv') # dataset of public K-12 spending by school

school_data_clean <- school_data %>%
  filter(flag_nerds == 'false') %>%
  filter(flag_f33 != '1')
```

school_data identified by ncesid at school level -- 10404


### ela_metric_data

[Codebook](https://github.com/JeremyHub/STAT-456-Final/blob/8ef6fa6ce28785065f583f4c477c5deb11afd442/final_project_stuff/ela_docs.pdf)

```{r ela_metric_data}
ela_metric_data <- read.csv('ca_edu_metrics.csv') # 2022 Academic Indicator (English Language Arts/Literacy) Data File

ela_metric_data_clean <- ela_metric_data %>%
  filter(cds > 0, rtype == 'S') %>% # school record
  select(-color, -box) %>%
  mutate(cds_standardized = as.character(paste0("0", cds)))

colnames(ela_metric_data_clean) <- paste0("ela_data_", colnames(ela_metric_data_clean))
valuecols<-names(ela_metric_data_clean)[10:21]

ela_wide <- ela_metric_data_clean %>% pivot_wider(names_from = ela_data_studentgroup, values_from = valuecols, names_sep = "_") %>% mutate(ela_data_cds = as.character(ela_data_cds))
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
names(ela_metric_data)
length(levels(factor(ela_metric_data_clean$cds)))
```


ela_metric_data identified by cds at school level -- 9845 AND student group -- 165532

### ela and math metrics

```{r}
ela_mth_proficiency_ranges<-read.csv("nathanieldata.csv") %>% filter(GRADE == "00" & CATEGORY == "ALL") %>% mutate(NCESSCH = as.character(NCESSCH), NCESSCH = paste0("0",NCESSCH))
```




### science_metric_data

[Codebook](https://github.com/JeremyHub/STAT-456-Final/blob/8ef6fa6ce28785065f583f4c477c5deb11afd442/final_project_stuff/science_docs.pdf)

```{r science_metric_data}
science_metric_data <- read.csv('science_ca_assesment.csv', sep = "^")

science_metrics_clean <- science_metric_data %>%
  mutate(cds = as.character(paste0(0, paste0(paste0(County.Code,District.Code),paste0(0,School.Code))))) %>% # add cds identifier
  # mutate(cds_standardized = ifelse(nchar(cds) == 13, as.character(paste0(0,cds)), cds)) %>% # there are school codes missing the last 0, this fixes that to match other cds
  filter(County.Code > 0, Type.ID == 07) %>%
  select(-County.Code, -District.Code, -School.Code, -Filler) 


valuecols <- c(names(science_metrics_clean)[8:25],names(science_metrics_clean)[4:5])
science_metrics_wide <- science_metrics_clean %>% pivot_wider(names_from = Grade, values_from = valuecols)
colnames(science_metrics_wide) <- paste0("science_data_", colnames(science_metrics_wide))

colnames(science_metrics_clean) <- paste0("science_data_", colnames(science_metrics_clean))
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
length(levels(factor(science_metrics_clean$cds_standardized)))
levels(factor(science_metrics_clean$science_data_Grade))
```


science_metrics_clean identified by cds_standardized at school level -- 8819 AND Grade -- 25298


### stanford_data and cov

[Codebook](https://github.com/JeremyHub/STAT-456-Final/blob/82e84dd90db010d96edba2d74dc574c15648a10c/final_project_stuff/stanford_codebook.xlsx)  

[Covariate Codebook](https://github.com/JeremyHub/STAT-456-Final/blob/82e84dd90db010d96edba2d74dc574c15648a10c/final_project_stuff/stanford_cov_codebook.xlsx)

```{r}
stanford_data <- read.csv('seda_school_pool_gcs_4.1.csv')
stanford_cov <- read.csv("seda_cov_school_pool_4.1.csv")

stanford_cov <- stanford_cov %>% filter(stateabb == "CA")

stanford_data_clean <- stanford_data %>% 
  filter(stateabb == 'CA') %>% 
  select(sedasch, sedaschname, fips, stateabb, subcat, subgroup, gradecenter, gap, contains("avg"), -ends_with("se")) %>%
  mutate(standardized_school_id = paste0("0", sedasch)) %>% # adding 0 in front of school id to match the format of the school dataset
  left_join(stanford_cov)

```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
length(levels(factor(stanford_data_clean$standardized_school_id)))
```

stanford_data AND stanford_cov identify eachother by sedasch

stanford_data AND stanford_cov identified by standardized_school_id -- 8512

### ca_school_details

```{r}
ca_school_details <- read_excel("ca_school_details.xlsx") # CA schools metadata

ca_school_details_clean <- ca_school_details %>%
  filter(StatusType == "Active") %>%
  filter(School != "No Data") %>%
  mutate(school_id = paste0(NCESDist, NCESSchool))
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
length(levels(factor(ca_school_details_clean$school_id)))
```

ca_school_details_clean identified by school_id -- 10629

## Joining

```{r}
wide_merged_data <- ca_school_details_clean %>% 
  left_join(school_data_clean, by=c('school_id'='ncesid')) %>%
  left_join(science_metrics_wide, by = c("CDSCode"="science_data_cds")) %>%
  left_join(ela_wide, by = c("CDSCode"="ela_data_cds_standardized")) %>% 
  left_join(stanford_data_clean, by=c('school_id'='standardized_school_id')) %>% 
  mutate(ncesid = paste0(NCESDist,NCESSchool)) %>%
  left_join(ela_mth_proficiency_ranges, by=c("ncesid"="NCESSCH"))

names(wide_merged_data)
```

```{r}
length(unique(wide_merged_data$CDSCode)) #10629 unique schools from the metadata
length(unique(wide_merged_data$CDSCode[is.na(wide_merged_data$schoolname) == FALSE])) #4385 unique matched schools for Jeremy's california school data
length(unique(wide_merged_data$CDSCode[is.na(wide_merged_data$sedasch) == FALSE])) #7390 unique matched schools for Stanford data
length(unique(wide_merged_data$CDSCode[is.na(wide_merged_data$ela_data_cds) == FALSE])) #814 unique matched schools for ela data
length(unique(wide_merged_data$CDSCode[is.na(wide_merged_data$science_data_cds) == FALSE])) #495 unique matched schools for science data
length(unique(wide_merged_data$CDSCode[is.na(wide_merged_data$PE_data_cds) == FALSE])) #501 unique matched schools for pe data
```

```{r}
wide_merged_data %>% ggplot(aes(x=as.numeric(science_data_Percentage.Standard.Met.and.Above_13), y=(as.numeric(gcs_mn_avg_ol)-as.numeric(gradecenter)))) +
  geom_point() +
  geom_smooth(method = lm)
```
```{r warning=FALSE}
wide_merged_data %>% ggplot(aes(x=as.numeric(pp_total_norm_NERDS), y=(as.numeric(gcs_mn_avg_ol)-as.numeric(gradecenter)), xintercept = )) +
  geom_point(alpha = .1) + 
  geom_smooth(method = lm) + 
  facet_wrap(~locale) + 
  scale_x_continuous(limits = c(8000,18000))

wide_merged_data %>% ggplot(aes(x=as.numeric(pp_total_norm_NERDS), y=as.numeric(Zip), xintercept = )) +
  geom_point(alpha = .1) + 
  geom_smooth()+
  # facet_wrap(~locale) + 
  scale_x_continuous(limits = c(0,25000))


wide_merged_data %>% ggplot(aes(y=as.numeric(pp_total_norm_NERDS),color=locale)) +
  geom_boxplot(alpha = .1) +
  scale_y_continuous(limits = c(5000,35000))


```

```{r}
counties <- st_as_sf(maps::map("county", plot = FALSE, fill = TRUE))
counties <- subset(counties, grepl("california", counties$ID))
world <- ne_countries(scale = "medium", returnclass = "sf")

ggplot(data = world) +
  geom_sf(data = counties, fill='#e0f0e3') + 
  geom_point(data = (wide_merged_data%>%filter(!is.na(gradecenter)&!is.na(gcs_mn_avg_ol))) , aes(x=as.numeric(Longitude),y=as.numeric(Latitude),color=(as.numeric(gcs_mn_avg_ol)-as.numeric(gradecenter))),size=.3) +
  theme_classic() +
  scale_color_met_c("Benedictus",direction = 1)



ggplot(data = world) +
  geom_sf(data = counties, fill='#e0f0e3') + 
  geom_point(data = (wide_merged_data) , aes(x=as.numeric(Longitude),y=as.numeric(Latitude),color=as.numeric(perhsp)),size=.3) +
  theme_classic() +
  scale_color_met_c("Benedictus",direction = 1)


ggplot(data = world) +
  geom_sf(data = counties, fill='#e0f0e3') + 
  geom_point(data = (wide_merged_data%>%filter(as.numeric(pp_total_norm_NERDS)>8000 & as.numeric(pp_total_norm_NERDS) < 25000)) , aes(x=as.numeric(Longitude),y=as.numeric(Latitude),color=(as.numeric(pp_total_norm_NERDS))),size=.3) +
  theme_classic() + scale_color_met_c("Benedictus",direction = 1)
```
