---
title: "Beyond the Report Card: What are the insights at the school level that we can observe?"
author: "Thu Dang, Nathaniel Reimer, Jeremy Hubinger"
execute: 
  echo: false
  warning: false
  message: false
  freeze: auto
bibliography: Library.bib
---

```{r packages}
library(tidyverse)
library(MetBrewer)
library(sf)
library(rnaturalearth)
library(classInt) #install.packages('classInt')
library(ggspatial) #install.packages('ggspatial')
library(ggthemes) #install.packages('ggthemes')
library(RColorBrewer)
library(patchwork)
library(leaflet)
library(probably) #install.packages('probably')
library(glmnet)
library(tidymodels)
tidymodels_prefer()
```

```{r color}
palname = "Homer2"
defaultcolor = met.brewer(palname,10)[9]
```

```{r load datasets}
load("CombinedDataLongFormat.RData")
load("WideMergedData.RData")
```

```{r load cleaned dataset for county achievement metrics}
math_ca_gcs_df <- read_csv("AllDatasets/math_ca_gcs_df.csv")
rla_ca_gcs_df <- read_csv("AllDatasets/rla_ca_gcs_df.csv")
```

```{r maps load shapefile}
ca_counties <- read_sf('CA_Counties')
ca_counties <- ca_counties %>%
  st_transform(crs = "NAD83")
```


## School-level academic achievement across California

Let's now take a closer look at the statistics on the individual school level. To create this map, we find the GCS score for each school and divide the schools into 5 categories, then we place a marker at the approximate location based on available latitude and longitude data. Note that the range of GCS scores is much wider now since we are looking at individual schools rather than the county average.

```{r funding/performance map}
mapdata <- wide_merged_data %>% filter(!is.na(gradecenter)&!is.na(gcs_mn_avg_ol)) %>% 
  mutate(diff_from_gradecenter = gcs_mn_avg_ol - gradecenter, pp_total_raw = as.numeric(pp_total_raw)) %>%
  mutate(Longitude = as.numeric(Longitude), Latitude = as.numeric(Latitude)) %>%
  mutate(pp_total_raw_cat = cut(pp_total_raw, breaks = c(0,10000,15000,20000,Inf))) %>%
  mutate(diff_from_gradecenter_cat = cut(diff_from_gradecenter, breaks = c(-Inf, -3, -1, 1, 3, Inf)))

p1 <- colorFactor(
  palette = met.brewer(palname, 5)[1:5],
  domain = mapdata$diff_from_gradecenter_cat
)

pal <- colorFactor(
  palette = met.brewer(palname, 4)[1:4],
  domain = mapdata$pp_total_raw_cat
)

leaflet(mapdata) %>% addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircleMarkers(
    color = ~p1(diff_from_gradecenter_cat),
    radius = ~(as.numeric(ncesenroll)/400),
    popup = ~paste0(School, 
                    "<br>Grade Distance from National Average: ", round(diff_from_gradecenter, digits = 3),
                    "<br>Per Pupil Funding: ", pp_total_raw,
                    "<br>Enrollment: ", ncesenroll
    ),
    group = "Achievement"
  ) %>% 
  addLegend(position = "bottomright", colors = met.brewer(palname, 5)[1:5], title = "Achievement", labels = c("3+ years behind", "1-3 years behind",  "Within 1 year of national average",  "1-3 years ahead", "3+ years ahead"))
```
<br>
Schools closer to urban areas appear to have higher achievement than schools in rural areas. Zooming in on just the San Francisco Bay we see that there is a tremendous amount of variation in achievement: schools in San Jose are years behind while a swath of schools in Palo Alto, Mountain View, and Cupertino boast testing achievement more than three years ahead. On the east side of the bay in Oakland, schools just blocks apart are separated by multiple years in achievement. Further afield, Los Angeles and Sacramento have areas of very low achievement then areas of higher achievement further out, almost resembling a bullseye. How do we account for this variation?

## Does funding impact school-level academic achievement?

Advocacy groups have long debated the influence of funding on academic achievement. Conservative groups like The Heritage Foundation note that funding, in real terms, has increased significantly since the 70s but achievement has stayed flat. They argue that more funding will do little to improve outcomes [@money_heritage]. On the other hand, an assortment of studies find that funding does have a measurable impact on achievement, but how the money is spent important [@money_edweek].

We map California school per-pupil funding data in four spending categories. There are schools with funding well in excess of $20,000 per student, but most are accurately represented by these categories.

```{r}

leaflet(mapdata) %>% addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircleMarkers(
    color = ~pal(pp_total_raw_cat),
    radius = ~(as.numeric(ncesenroll)/400),
    popup = ~paste0(School, 
                    "<br>Grade Distance from National Average: ", round(diff_from_gradecenter, digits = 3),
                    "<br>Per Pupil Funding: ", pp_total_raw,
                    "<br>Enrollment: ", ncesenroll
    ),
    stroke = ~ifelse(!is.na(pp_total_raw_cat), TRUE, FALSE),
    group = "Funding",
    fillOpacity = 0
  ) %>%
addLegend("bottomright", colors = met.brewer(palname, 4)[1:4], title = "Per Student Funding", labels = c("$10,000 or less", "$10,000 to $15,000", "15,000 to 20,000", "Greater than 20,000")) %>%
  addCircleMarkers(
    color = "grey",
    radius = ~(as.numeric(ncesenroll)/400),
    popup = ~paste0(School, 
                    "<br>Grade Distance from National Average: ", round(diff_from_gradecenter, digits = 3),
                    "<br>Per Pupil Funding: ", pp_total_raw,
                    "<br>Enrollment: ", ncesenroll
    ),
    fillOpacity = 0,
    stroke = ~ifelse(is.na(pp_total_raw_cat), TRUE, FALSE),
    group = "Show Schools with Unknown Funding",
    options = list(visible = FALSE)
  ) %>% 
  addLayersControl(overlayGroups = "Show Schools with Unknown Funding",
                   position = "bottomleft", options = layersControlOptions(collapsed = FALSE)) %>%
  addEasyButton(easyButton(
    icon = htmltools::HTML("<span style='font-size: 16px; padding: 0px;'>Zoom to Boston</span>"), title = "Zoom to Level 1",
    onClick = JS("function(btn, map){map.setView([42.3601, -71.0589], 16);}")))
  
```
<br>
There are a striking number of schools with no funding data. Nevertheless, the types of areas that are excluded don't appear to follow a clear trend.

Among schools with available funding data, correlations with achievement are confusing. The high-achieving schools we saw earlier in the Palo Alto area receive very high funding but, in Oakland, the schools with the highest funding have some of the lowest levels of achievement. South of Los Angeles, the high achieveing schools in Huntington Beach are funded at levels close to and below $10,000 per student. 

```{r funding and performance by area}
wide_merged_data %>% filter(!is.na(urbanicity)) %>%
  ggplot(aes(x=as.numeric(pp_total_raw), y=(as.numeric(gcs_mn_avg_ol)-as.numeric(gradecenter)))) +
  geom_point(alpha = .1, color=defaultcolor) + 
  geom_smooth(color=defaultcolor) + 
  facet_wrap(~urbanicity) + 
  scale_x_continuous(limits = c(8000,18000)) + 
  theme_minimal()+
  labs(y="Grade Cohort Score", x= "Unadjusted Per Student Spending") + guides(color="none") +   geom_hline(yintercept = 0)
```

Overall, regardless of area, higher per pupil funding is associated with lower growth scores. In California schools receive a base per-pupil grant dependent on the grades taught in the school. Schools receive supplemental funding based on the percent of students eligible for free and reduced lunch, the percent in the foster care system, and the percent that have limited English. We use a linear model of funding based solely on the percent of students eligible for free and reduced lunch to adjust funding. The negative relationship dissapears:

```{r funding model, results='hide'}
#| message: true
fundingmod<-wide_merged_data %>% 
  filter(!is.na(pp_total_raw)&!is.na(perfrl)) %>% 
  lm(formula = as.numeric(pp_total_raw) ~ as.numeric(perfrl) + 
       as.numeric(lep_flag) + 
       as.numeric(perfrl)*as.numeric(lep_flag)) %>%
  summary()

lunchfundingmod<-wide_merged_data %>% 
  filter(!is.na(pp_total_raw)&!is.na(perfrl)) %>% 
  lm(formula = as.numeric(pp_total_raw) ~ as.numeric(perfrl)) %>%
  summary()

# fundingmod$coefficients
lunchfundingmod$coefficients
```

```{r area adjusted graph}
wide_merged_data %>% filter(!is.na(urbanicity)) %>% mutate(pp_total_raw_frl_adjusted = as.numeric(pp_total_raw) - as.numeric(perfrl)*lunchfundingmod$coefficients[2],
  pp_total_raw = as.numeric(pp_total_raw)) %>%
  ggplot(aes(x=as.numeric(pp_total_raw_frl_adjusted), y=(as.numeric(gcs_mn_avg_ol)-as.numeric(gradecenter)))) +
  geom_point(alpha = .1, color=defaultcolor) + 
  geom_smooth( color=defaultcolor) + 
  facet_wrap(~urbanicity) + 
  scale_x_continuous(limits = c(8000,18000)) + 
  theme_minimal()+
  labs(y="Grade Cohort Score", x= "Adjusted Per Student Spending") + guides(color="none") +   geom_hline(yintercept = 0)

```

In the suburbs and city there appears to be a slight positive relationship between funding and achievement but our data and analysis really is not suited to pinpoint that effect. 

There are still things we can take away from this analysis. Socioeconomic status, measured as the percent of students eligible for free and reduced lunch, significantly effects achievement. Additional funding received by schools with a high proportion of disadvantaged students does not affect achievement enough to offset the impact of socioeconomic status. The Education Trust finds that California's school funding scheme is relatively progressive when comparing high and low-poverty school districts [@money_edtrust]. When adjusting for the additional needs of low income students, however, they say that California is merely 'neutral.' 



```{r adjusted graphs}
#| eval: false
fl<-c("Adjusted Spending","Raw Spending")
wide_merged_data %>%
  mutate(pp_total_raw_frl_adjusted = as.numeric(pp_total_raw) - as.numeric(perfrl)*lunchfundingmod$coefficients[2],
  pp_total_raw = as.numeric(pp_total_raw)) %>%
  pivot_longer(cols = c(pp_total_raw_frl_adjusted,pp_total_raw)) %>%
  ggplot(aes(x=value, y=gcs_mn_avg_ol-gradecenter, color = name)) + 
    geom_point(alpha = .1)+
    geom_smooth() +
    geom_hline(yintercept = 0, alpha=.5) + 
    scale_x_continuous(limits = c(8000,18000)) +
    scale_y_continuous(limits = c(-4, 4)) +
    scale_color_discrete(type = met.brewer(palname, 3)[2:3], labels = c("Raw Spending", "Adjusted Spending")) + 
    labs(x = "Per Student Funding", y = "Grade Cohort Score", color="") + 
    theme_minimal() + 
    theme(legend.position = c(.8,.81))


wide_merged_data %>%
  mutate(pp_total_raw_frl_adjusted = as.numeric(pp_total_raw) - as.numeric(perfrl)*lunchfundingmod$coefficients[2],
  pp_total_raw = as.numeric(pp_total_raw)) %>%
  pivot_longer(cols = c(pp_total_raw_frl_adjusted,pp_total_raw)) %>%
 ggplot(aes(x=as.numeric(perhsp),value,color=name)) +
      geom_point(alpha = .05) +
      geom_smooth() + 
      theme_minimal()+
      theme(legend.position = c(.2,.9) ) + 
      labs(x="Percent Hispanic", y="Per student funding", color="")+
      scale_y_continuous(limits = c(5000,20000)) +
      scale_color_discrete(type = met.brewer(palname, 3)[2:3], labels = c("Raw Spending", "Adjusted Spending"))
```






