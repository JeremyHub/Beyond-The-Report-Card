---
title: "Beyond the Report Card: What are the significant predictors?"
author: "Thu Dang, Nathaniel Reimer, Jeremy Hubinger"
execute: 
  echo: false
  warning: false
  message: false
  freeze: auto
---

```{r packages}
library(tidyverse)
library(MetBrewer)
library(sf)
library(rnaturalearth)
library(classInt) #install.packages('classInt')
library(ggspatial) #install.packages('ggspatial')
library(ggthemes) #install.packages('ggthemes')
library(RColorBrewer)
library(patchwork)
library(leaflet)
library(probably) #install.packages('probably')
library(glmnet)
library(tidymodels)
library(ggrepel)
tidymodels_prefer()
```

```{r color}
palname = "Homer2"
defaultcolor = met.brewer(palname,10)[9]
```

```{r load datasets}
load("CombinedDataLongFormat.RData")
load("WideMergedData.RData")
```

```{r load cleaned dataset for county achievement metrics}
math_ca_gcs_df <- read_csv("AllDatasets/math_ca_gcs_df.csv")
rla_ca_gcs_df <- read_csv("AllDatasets/rla_ca_gcs_df.csv")
```

```{r maps load shapefile}
ca_counties <- read_sf('CA_Counties')
ca_counties <- ca_counties %>%
  st_transform(crs = "NAD83")
```

```{r lasso data setup}

min_max_norm <- function(x) {
    (x - min(x, na.rm=TRUE)) / (max(x, na.rm=TRUE) - min(x, na.rm=TRUE))
}

data <- wide_merged_data %>% 
  mutate(pp_total_raw = as.numeric(pp_total_raw)) %>%
  mutate(science_data_Earth.and.Space.Sciences.Domain.Percent.Above.Standard_99 = as.numeric(science_data_Earth.and.Space.Sciences.Domain.Percent.Above.Standard_99),
        science_data_Physical.Sciences.Domain.Percent.Above.Standard_99 = as.numeric(science_data_Physical.Sciences.Domain.Percent.Above.Standard_99),
        science_data_Life.Sciences.Domain.Percent.Above.Standard_99 = as.numeric(science_data_Life.Sciences.Domain.Percent.Above.Standard_99),
        ela_data_currstatus_ALL = as.numeric(ela_data_currstatus_ALL),
        gcs = as.numeric(gcs_mn_avg_ol - gradecenter),
        growthscore_ela = as.numeric(growthscore_ela),
        growthscore_math = as.numeric(growthscore_math)
    ) %>% mutate(
        science_data_Earth.and.Space.Sciences.Domain.Percent.Above.Standard_99 = min_max_norm(science_data_Earth.and.Space.Sciences.Domain.Percent.Above.Standard_99),
        science_data_Physical.Sciences.Domain.Percent.Above.Standard_99 = min_max_norm(science_data_Physical.Sciences.Domain.Percent.Above.Standard_99),
        science_data_Life.Sciences.Domain.Percent.Above.Standard_99 = min_max_norm(science_data_Life.Sciences.Domain.Percent.Above.Standard_99),
        ela_data_currstatus_ALL = min_max_norm(ela_data_currstatus_ALL),
        gcs = min_max_norm(gcs_mn_avg_ol - gradecenter),
        growthscore_ela = min_max_norm(growthscore_ela),
        growthscore_math = min_max_norm(growthscore_math)
    ) 

# Lasso Model Spec
lm_lasso_spec <- 
  linear_reg() %>%
  set_args(mixture = 1, penalty = 0) %>%
  set_engine(engine = 'glmnet') %>% 
  set_mode('regression') 
```

```{r lasso data split}
outcome <- data %>% select(ela_data_currstatus_ALL, gcs, science_data_Earth.and.Space.Sciences.Domain.Percent.Above.Standard_99, science_data_Life.Sciences.Domain.Percent.Above.Standard_99, science_data_Physical.Sciences.Domain.Percent.Above.Standard_99, growthscore_ela, growthscore_math)

predictors <- ((data %>% select(-starts_with("science_data"), -starts_with("ela_data")))[27:151]) %>% select(-census_id,-DATE_CUR,-CATEGORY,-ST_LEAID,-LEANM,-ST_SCHID,-SCHNAM,-GRADE,STNAM,-FIPST,-LEAID,-reported_which,-reportingyear,-studentgroup,-schoolname.y,       -districtname,-countyname,-EILCode,-EILName,-SOC,-DOC,-YearRoundYN,-FederalDFCDistrictID,-Latitude,-Longitude,-AdmFName,-AdmLName,-AdmEmail,-LastUpDate,-school_id,-         schoolname.x,-ncesdistid_admin,-ncesdistid_geo,-distid_stateassigned,-schoolid_stateassigned,-distname,-address,-city,-state,-zip_code,-level.x,-sedasch,-sedaschname         ,-fips,-stateabb,-subcat,-subgroup,-sedalea,-schnam,-schcity,-type,-level.y,-ncesid,-rtype,-SCHOOL_YEAR,-STNAM,-X, -GSoffered) %>%
  select(-contains("growthscore"), -contains("decilerank"), -starts_with("ELA"), -starts_with("MTH"), -charter_flag, -coe_flag, -dass_flag, -enrollmetric_raw, -gcs_mn_avg_ol, -gcs_mn_avg_eb) %>%
  mutate(across(starts_with("pp"), as.numeric)) %>%
  mutate(across(ends_with("raw"), as.numeric)) %>% 
  mutate(ncesenroll = as.numeric(ncesenroll))
```

```{r lasso function}
#| fig-width: 50
#| fig-height: 10
do_lasso<-function(variable, data, labels, y_nudge, x_nudge) {
    
    processeddata <- cbind(variable, data) %>%
      filter(complete.cases(.))

  
    data_rec <- recipe(variable ~ ., data = processeddata) %>%
      step_nzv(all_predictors()) %>%
      step_novel(all_nominal_predictors()) %>%
      step_normalize(all_numeric_predictors()) %>%
      step_dummy(all_nominal_predictors())
    
    lasso_wf <- workflow() %>%
      add_recipe(data_rec) %>%
      add_model(lm_lasso_spec)
    
    lasso_fit <- lasso_wf %>%
      fit(data = processeddata) # Fit to data
    
    glmnet_output <- lasso_fit %>% extract_fit_parsnip() %>% pluck('fit')
    
    
    lambdas <- glmnet_output$lambda
    coefs_lambdas <- 
      coefficients(glmnet_output, s = lambdas )  %>% 
      as.matrix() %>%  
      t() %>% 
      as.data.frame() %>% 
      mutate(lambda = lambdas ) %>% 
      select(lambda, everything(), -`(Intercept)`) %>% 
      rename(`% Asian` = perasn, `% Black` = perblk, `% Economically Disadvantaged` = perecd, `% Free/Reduced Lunch` = perfl, `Serves Grades 6-9` = GSserved_X6.9, `Serves Grades K-12` = gradespan_KG.12) %>%
      pivot_longer(cols = -lambda, 
                   names_to = "term", 
                   values_to = "coef") %>%
      mutate(var = purrr::map_chr(term,~.[1]))
    
      number <- nrow(processeddata)
      name <- deparse(substitute(variable))
      
      middle <- coefs_lambdas$lambda[[floor(length(coefs_lambdas$lambda)*0.2)]]
      
      coefs_lambdas %>%
        ggplot(aes(x = lambda, y = coef, group = term, color = var)) +
          labs(subtitle = paste0("based on ",number, " schools' data")) +
          geom_line() +
          theme_classic() + 
          theme(legend.position = "none", legend.text=element_text(size=8)) +
          geom_label_repel(data = coefs_lambdas %>% filter(lambda == middle, (coef > 0.01) | (coef < -0.01)), aes(x = lambda, y = coef, label = var), max.overlaps = 100, nudge_y = y_nudge, nudge_x = x_nudge) +
          labs(x="Penalty", y="Significance") +
          labels
}
```

# Let's revisit the goal

In order to explore the factors that contribute to variations between metrics, we will examine the predictors for each metric. This entails analyzing the factors that have a significant positive or negative influence on distinct metrics of educational outcomes for schools/individuals.

To facilitate this analysis, we will compare various metrics and scores that we have previously studied, including the Grade Cohort Standardized (GCS) Score and both ELA and Math growth scores.

It is important to note that this analysis will be conducted at the school level, whereby all the predictors will be aggregated for each school. For instance, the predictor for free/reduced lunch will be the percentage of students at a given school who receive free or reduced lunch.

# LASSO

## Why LASSO

To investigate the significance of predictors, we will utilize a technique known as LASSO (Least Absolute Shrinkage and Selection Operator). This approach involves identifying the most influential predictors out of numerous possibilities that explain the majority of the variation in the outcome variable. In our case, the outcome variable is the specific educational outcome metric we are analyzing, while the predictors are various characteristics of the school.

## How to interpret a LASSO graph

LASSO provides us with a visual representation of which predictors are responsible for the most variation in the metric. It's important to note a few things while analyzing the LASSO graphs below. Each line on the graph corresponds to an individual predictor, such as "percentage of students who are white" or "school grade span," among others. The most significant predictors are indicated on the graph.

A predictor is considered significant if its Y-value remains consistently above or below zero for high penalty values. In other words, if the line for a predictor on the graph reaches zero at higher X-values, it is more significant, meaning it accounts for a greater amount of variability in the outcome, compared to a predictor that reaches zero at low X-values.

## Note on predictors

Some predictors are numerical and some are categorical. Numerical predictors are fairly straightforward. If the line for a numerical predictor is above zero then the higher that predictor is for any given school, the higher the outcome metric will be. And vise versa if the predictor is below. Numerical predictors are predictors such as demographics. There are also categorical predictors. If a line for a categorical predictor (such as whether the school serves kids from K-12 or not) is above zero then if that category is true for a school the associated metric will be higher and vise versa if it is below.

# Results

## Grade Cohort Standardized (GCS) Scores

First, we examine the significant predictors for the GCS Score at school level. The LASSO graph shows that the percentage of students who are Asian is a relatively strong predictor. However, the most significant predictors are the percentage of students receiving free/reduced lunch and the percentage of students considered economically disadvantaged.

```{r perform lasso pt1}
do_lasso(outcome$gcs, predictors, labs(title="Significant Predictors of GCS Score"), c(0.1, -0.1, -0.1), 0.03)
```

## ELA & Math Growth Scores

Moving on to the growth scores for ELA and Math, we observe that all the predictors converge to zero much faster than in the previous two graphs. This is evident from the absolute numbers on the X-axis, which are much smaller (around 0.01 - 0.03 penalty) compared to the previous graphs (around 0.1 - 0.15 penalty). This indicates that none of the predictors are as significant as those in the previous graphs. Nevertheless, there are some predictors that are marginally significant, including the ones identified earlier, as well as two additional categories related to the grades served by the school.

```{r perform lasso pt2}
do_lasso(outcome$growthscore_ela, predictors, labs(title="Significant Predictors of ELA Growth Score"), -0.1, 0.005)
do_lasso(outcome$growthscore_math, predictors, labs(title="Significant Predictors of Math Growth Score"), c(0.15, -0.1, -0.1), 0.01)
```
